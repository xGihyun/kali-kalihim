---
import Layout from "@/components/layouts/layout.astro";
import UserProfile from "@/components/user/profile";
import UserChart from "@/components/user/admin/charts/user";
import TopPlayers from "@/components/user/admin/top-players";
import { db } from "@/drizzle/db";
import {
  ArnisSeasonsTable,
  PlayerSeasonDetailsTable,
  UserDetailsTable,
  UsersTable,
} from "@/drizzle/schema";
import { count, desc, eq } from "drizzle-orm";

const userRoles = await db
  .select({
    role: UsersTable.role,
    count: count(UsersTable.role),
  })
  .from(UsersTable)
  .groupBy(UsersTable.role);

const [latestSeason] = await db
  .select({ arnisSeasonId: ArnisSeasonsTable.arnisSeasonId })
  .from(ArnisSeasonsTable)
  .orderBy(desc(ArnisSeasonsTable.createdAt))
  .limit(1);

const topPlayers = await db
  .select({
    userId: UserDetailsTable.userId,
    firstName: UserDetailsTable.firstName,
    middleName: UserDetailsTable.middleName,
    lastName: UserDetailsTable.lastName,
    rating: PlayerSeasonDetailsTable.rating,
  })
  .from(UserDetailsTable)
  .innerJoin(
    PlayerSeasonDetailsTable,
    eq(PlayerSeasonDetailsTable.userId, UserDetailsTable.userId),
  )
  .where(eq(PlayerSeasonDetailsTable.arnisSeasonId, latestSeason.arnisSeasonId))
  .orderBy(desc(PlayerSeasonDetailsTable.rating))
  .limit(5);
---

<Layout title="Home">
  <UserProfile />

  <UserChart userRoles={userRoles} client:load />

  <TopPlayers players={topPlayers} />
</Layout>
